<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Vectorizing old code and measuring speed</title>
        <link rel="stylesheet" href="http://localhost:8000/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://localhost:8000/">All Time Free Time </a></h1>
                <nav><ul>
                    <li><a href="http://localhost:8000/about/">About</a></li>
                    <li><a href="http://localhost:8000/category/c/">C</a></li>
                    <li><a href="http://localhost:8000/category/japan/">japan</a></li>
                    <li class="active"><a href="http://localhost:8000/category/python/">Python</a></li>
                    <li><a href="http://localhost:8000/category/uncategorized/">Uncategorized</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://localhost:8000/2017/07/31/vectorizing-old-code-and-measuring-speed/" rel="bookmark"
           title="Permalink to Vectorizing old code and measuring speed">Vectorizing old code and measuring speed</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-07-31T18:15:00+02:00">
                Published: Mon 31 July 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://localhost:8000/author/frank/">frank</a>
        </address>
<p>In <a href="http://localhost:8000/category/python/">Python</a>.</p>
<p>tags: <a href="http://localhost:8000/tag/numpy/">Numpy</a> <a href="http://localhost:8000/tag/optimization/">optimization</a> <a href="http://localhost:8000/tag/python/">Python</a> </p>
</footer><!-- /.post-info -->      <p>I just finished refactoring a piece of code that was not so well written. We make use of Numpy arrays to store our timeseries. This particular piece of code didn't use native Numpy methods, but instead used a for-loop to iterate over every timestep in the array. This part also had other issues, so it needed some work.</p>
<p>Vectorizing this kind of code can seem similar to black magic. You need to know Numpy tricks to make it happen. Luckily the internet is filled with them. I used for example a neat trick to find constant parts with a minimum length, inspired by <a href="https://stackoverflow.com/a/1068397">this post</a>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c1"># Find parts with three or more consecutive 2&#39;s:</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">index_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">array</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># Append 0 in front for correct length and in case array starts with a 2.</span>
<span class="n">switches</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index_bool</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># [2 5 7 9]</span>
<span class="k">for</span> <span class="n">ind_start</span><span class="p">,</span> <span class="n">ind_end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">switches</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">switches</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">ind_end</span> <span class="o">-</span> <span class="n">ind_start</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">ind_start</span><span class="p">:</span><span class="n">ind_end</span><span class="p">])</span>
</pre></div>


<p>The heavy lifting is done with Numpy routines, so as long as there are not too many switches, this code should be pretty fast. But how to test that?</p>
<p>For this snippet of code I used the <a href="https://docs.python.org/3.0/library/timeit.html">timeit module</a>. It's easy to use to test a small piece of code. Most examples use it from the command line, but here I wanted to use it in my script. The downside is that it doesn't automatically determine a suitable number of loops, so you will have to tweak the n-factor yourself. What I like about this method is that you can initialize anything before the test. That's very useful, since I often need resources from our server to do tests.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">timeit</span>

<span class="n">this</span> <span class="o">=</span> <span class="s1">&#39;something&#39;</span>

<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="n">here</span> <span class="o">=</span> <span class="s1">&#39;everything&#39;</span>
    <span class="n">why</span> <span class="o">=</span> <span class="n">this</span> <span class="o">+</span> <span class="n">here</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s2">&quot;example()&quot;</span><span class="p">,</span> <span class="s2">&quot;from __main__ import example&quot;</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">repeat</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">best_time</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">timer</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} loops, best of {}: {:.3f} us per loop.&#39;</span>
          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">best_time</span><span class="p">))</span>
</pre></div>


<p>I'm happy to report that after vectorizing the function performed 30 times faster than before. So apart from the issues I solved, I also saved 1.6 seconds on each run. But since this particular run took 60 seconds, it only amounts to 2.6 %. So in general I do not spend time vectorizing old code unless there is also some other, functional issue with it.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <!--<footer id="contentinfo" class="body">-->
                <!--<address id="about" class="vcard body">-->
                <!--Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.-->
                <!--</address>&lt;!&ndash; /#about &ndash;&gt;-->

                <!--<p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>-->
        <!--</footer>&lt;!&ndash; /#contentinfo &ndash;&gt;-->

</body>
</html>