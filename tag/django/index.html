<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>All Time Free Time - Django</title>
        <link rel="stylesheet" href="https://conengmo.github.io/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://conengmo.github.io/">All Time Free Time </a></h1>
                <nav><ul>
                    <li><a href="https://conengmo.github.io/about/">About</a></li>
                    <li><a href="https://conengmo.github.io/category/c/">C</a></li>
                    <li><a href="https://conengmo.github.io/category/japan/">japan</a></li>
                    <li><a href="https://conengmo.github.io/category/python/">Python</a></li>
                    <li><a href="https://conengmo.github.io/category/uncategorized/">Uncategorized</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://conengmo.github.io/2019/04/01/local-and-remote-database-in-django/">Local and remote database in Django</a></h1>
<footer class="post-info">
        <abbr class="published" title="2019-04-01T20:13:00+02:00">
                Published: Mon 01 April 2019
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://conengmo.github.io/author/frank/">frank</a>
        </address>
<p>In <a href="https://conengmo.github.io/category/python/">Python</a>.</p>
<p>tags: <a href="https://conengmo.github.io/tag/python/">Python</a> <a href="https://conengmo.github.io/tag/django/">Django</a> <a href="https://conengmo.github.io/tag/database/">database</a> </p>
</footer><!-- /.post-info --><p>In my work we use Django with a MySQL database. It's an important part of development to manage all the data in it. I use both a local database and the remote database simultaneously in development.</p>
<h2>Why use a local database?</h2>
<p>So you can write to it. You should not be able to write to the remote database while developing (I hope!), only read.
If you write code that will write to the database, you should test that locally. Authentication logic for example needs a database to write to.</p>
<h2>Then why also use the remote database?</h2>
<p>If you use data from the remote database, you're using the actual data your code will work with. You will find bugs that you may not have found with local dummy data.
But if you copy the remote to your local database, keeping that up to date is a chore that takes time and attention away from doing cool stuff.</p>
<h2>Can I have the best of both?</h2>
<p>Yes you can. You can use the remote database as much as possible, while using your local database when needed. And that almost automatically.</p>
<h1>Introducing Django router</h1>
<p>Django has an option to use multiple databases simultaneously. To let Django know when it should use which database, you can define a 'router' class. Django passes models it needs to use to perform a request to it, and expects the router to say which database it should use.</p>
<p><img alt="" src="https://conengmo.github.io/wp-content/uploads/2019/04/django-db-router-schema.png" width="760"></p>
<p>Here is the relevant page in the Django documentation:</p>
<p><a href="https://docs.djangoproject.com/en/stable/topics/db/multi-db/">https://docs.djangoproject.com/en/stable/topics/db/multi-db/</a></p>
<h1>Implementing the router</h1>
<h2>Settings file</h2>
<p>All the changes below I made in my settings file <code>local_settings.py</code> . Whenever I run Django I use that settings file.</p>
<h2>Define databases</h2>
<p>First, define the remote and the local database you want to use. Django doesn't work without a default, so I chose to use the remote database for that.</p>
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.mysql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;mydb&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;readonlyuser&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;password&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;host.hosting.net&gt;&#39;</span><span class="p">,</span>
    <span class="p">},</span>

    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.mysql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;mydb&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;localuser&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;localpassword&gt;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>


<h2>Define your local models, tables and apps</h2>
<p>You are free to make your own switches between local and remote, but here are three to get you started.
I define three <a href="https://duckduckgo.com/?q=python+sets">sets</a>: <code>Model</code> names, table names and app names.</p>
<div class="highlight"><pre><span></span><span class="n">local_models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ModelName&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">local_tables</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;django_session&#39;</span><span class="p">,</span>
    <span class="s1">&#39;auth_user&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">local_apps</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;social_django&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>By adding the <code>django_sesion</code> and <code>auth_user</code> tables and the <code>social_django</code> app, I make sure
all authentication will go through my local database.</p>
<h2>Create router class</h2>
<p>Below is the code for the router class, that determines which database will be used. </p>
<p>Django expects a router class to have <code>db_for_read</code> and <code>db_for_write</code> methods. It passes a <code>Model</code> object to them and expects an optional string database name in return. In our case that's either <code>'local'</code> or <code>None</code> for the default.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Router</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">local_models</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;local&#39;</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span> <span class="ow">in</span> <span class="n">local_tables</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;local&#39;</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="ow">in</span> <span class="n">local_apps</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;local&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</pre></div>


<h2>Activate the router</h2>
<p>Enable the router by simply specifying its location in the settings:</p>
<div class="highlight"><pre><span></span><span class="n">DATABASE_ROUTERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;local_settings.Router&#39;</span><span class="p">]</span>
</pre></div>


<h1>Side effects</h1>
<h2>Migrations</h2>
<p>Whenever you need to do a migration you need to specify which database Django should use. You can do that with the <code>--database</code> command line option. E.g.</p>
<p><code>python manage.py migrate --database local</code> </p>
<h2>Queries using both databases</h2>
<p>When you have a query that combines tables from both local and remote databases, Django will give an error. There are only two (simple) solutions: either move all tables in the query to your local database, or (temporarily) use the remote database for them all.</p>
<p>So in short, if a table you use locally has foreign keys it's best to also put those tables locally.</p>
<h1>Conclusion</h1>
<p>Using a Router enables you to have a local database for doing proper development while spending little time keeping your local database up to date with the remote.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <!--<footer id="contentinfo" class="body">-->
                <!--<address id="about" class="vcard body">-->
                <!--Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.-->
                <!--</address>&lt;!&ndash; /#about &ndash;&gt;-->

                <!--<p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>-->
        <!--</footer>&lt;!&ndash; /#contentinfo &ndash;&gt;-->

</body>
</html>